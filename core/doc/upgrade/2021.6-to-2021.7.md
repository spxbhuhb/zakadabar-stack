# Upgrade 2021-06 To 2021-07

This upgrade performs the following steps:

1. create `account_state` table
1. create `account_credential` table
1. copy data from `account_private`  to `account_state`
1. copy data from `account_private`  to `account_credential`
1. remove non-used columns from `account_private`

## Upgrade program

* [2021.6-to-2021.7.5.jar](https://zakadabar.io/2021.6-to-2021.7.5.jar)
* [PGP signature](https://zakadabar.io/2021.6-to-2021.7.5.jar.asc)

Check [Signatures](./Signatures.md) to see how to verify the signature.

## Running

1. stop the server
1. back up the database
1. copy the jar file into the `bin` directory
1. run upgrade command (see below)
1. delete the jar file from the `bin` directory
1. upgrade server JAR and `var/static`
1. start up the server
1. check results

### PostgreSQL, deployed

```text
java -jar 22021.6-to-2021.7.5.jar --settings ../etc/stack.server.yaml
```

### Non-PostgreSQL, deployed

To run with another DB, you have to specify classpath to include the DB jar:

```text
java -cp 2021.6-to-2021.7.5.jar:h2-1.4.200.jar \
     zakadabar.upgrade.u2021_6_to_2021_7.MainKt \
     --settings ../etc/stack.server.yaml
```

### Development, PostgresSQL

To run in a local development project (started from application template),
copy into the root of the project and use the following command.

```shell
java -jar 2021.6-to-2021.7.5.jar --settings ./template/app/etc/stack.server.yaml
```

### Development, H2

To run in a local development project (started from application template), 
copy into the root of the project and use the following command.

```text
java -cp 2021.6-to-2021.7.5.jar:h2-1.4.200.jar \
     zakadabar.upgrade.u2021_6_to_2021_7.MainKt \
     --settings ./template/app/etc/stack.server.yaml
```

### Example Run

```text
tiz@Bubu20 simplexion-web % java -cp 2021.6-to-2021.7.5.jar:h2-1.4.200.jar zakadabar.upgrade.u2021_6_to_2021_7.MainKt --settings ./template/app/etc/stack.server.yaml
Upgrading from 2021.6 to 2021.7 ...
/Users/tiz/src/simplexion-web/./template/app/etc/stack.server.yaml
2021-07-08 12:21:20.252 [main                          ] INFO  settings - ServerSettingsBo source: /Users/tiz/src/simplexion-web/./template/app/etc/stack.server.yaml
2021-07-08 12:21:20.283 [main                          ] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2021-07-08 12:21:20.418 [main                          ] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
Upgrade accounts...
2021-07-08 12:21:20.743 [main                          ] WARN  Exposed - Indices exist in database and not mapped in code on class 'ACCOUNT_CREDENTIAL':
2021-07-08 12:21:20.743 [main                          ] WARN  Exposed -                Index 'FK_ACCOUNT_CREDENTIAL_ACCOUNT_ID_INDEX_2' for 'ACCOUNT_CREDENTIAL' on columns zakadabar.upgrade.u2021_6_to_2021_7.AccountCredentialsExposedTable2021m7.account
Upgrade SUCCESSFUL
tiz@Bubu20 simplexion-web % 
```